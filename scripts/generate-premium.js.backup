#!/usr/bin/env node

/**
 * PREMIUM Ä°Ã§erik Ãœretim Scripti v5
 *
 * TÃœRKÄ°YE'NÄ°N EN KALÄ°TELÄ° TABÄ°AT REHBERÄ°
 *
 * Ã–zellikler:
 * - Wikidata API entegrasyonu (gerÃ§ek veriler)
 * - TÃ¼m bug'lar dÃ¼zeltildi
 * - Premium kalite promptlar
 * - Aggressive post-processing
 * - Profesyonel ton ve detay
 */

import Groq from 'groq-sdk';
import axios from 'axios';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import dotenv from 'dotenv';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

dotenv.config({ path: path.join(__dirname, '../.env') });

const MASTER_LISTS_DIR = path.join(__dirname, '../data/master-lists');
const CONTENT_DIR = path.join(__dirname, '../content/alanlar');

const groq = new Groq({ apiKey: process.env.GROQ_API_KEY });

const args = process.argv.slice(2);
const isTestMode = args.includes('test');

// Ä°l -> BÃ¶lge mapping
const IL_BOLGE_MAP = {
  'Ä°stanbul': 'Marmara', 'Edirne': 'Marmara', 'KÄ±rklareli': 'Marmara', 'TekirdaÄŸ': 'Marmara',
  'Ã‡anakkale': 'Marmara', 'BalÄ±kesir': 'Marmara', 'Bursa': 'Marmara', 'Kocaeli': 'Marmara',
  'Sakarya': 'Marmara', 'Bilecik': 'Marmara', 'Yalova': 'Marmara',
  'Ä°zmir': 'Ege', 'AydÄ±n': 'Ege', 'MuÄŸla': 'Ege', 'Denizli': 'Ege', 'Manisa': 'Ege',
  'UÅŸak': 'Ege', 'Afyonkarahisar': 'Ege', 'KÃ¼tahya': 'Ege',
  'Antalya': 'Akdeniz', 'Mersin': 'Akdeniz', 'Adana': 'Akdeniz', 'Hatay': 'Akdeniz',
  'KahramanmaraÅŸ': 'Akdeniz', 'Osmaniye': 'Akdeniz', 'Isparta': 'Akdeniz', 'Burdur': 'Akdeniz',
  'Ankara': 'Ä°Ã§ Anadolu', 'Konya': 'Ä°Ã§ Anadolu', 'EskiÅŸehir': 'Ä°Ã§ Anadolu', 'Kayseri': 'Ä°Ã§ Anadolu',
  'Sivas': 'Ä°Ã§ Anadolu', 'Yozgat': 'Ä°Ã§ Anadolu', 'KÄ±rÅŸehir': 'Ä°Ã§ Anadolu', 'NevÅŸehir': 'Ä°Ã§ Anadolu',
  'Aksaray': 'Ä°Ã§ Anadolu', 'NiÄŸde': 'Ä°Ã§ Anadolu', 'KÄ±rÄ±kkale': 'Ä°Ã§ Anadolu', 'Karaman': 'Ä°Ã§ Anadolu', 'Ã‡ankÄ±rÄ±': 'Ä°Ã§ Anadolu',
  'Trabzon': 'Karadeniz', 'Samsun': 'Karadeniz', 'Ordu': 'Karadeniz', 'Giresun': 'Karadeniz',
  'Rize': 'Karadeniz', 'Artvin': 'Karadeniz', 'GÃ¼mÃ¼ÅŸhane': 'Karadeniz', 'Bayburt': 'Karadeniz',
  'Amasya': 'Karadeniz', 'Tokat': 'Karadeniz', 'Ã‡orum': 'Karadeniz', 'Sinop': 'Karadeniz',
  'Kastamonu': 'Karadeniz', 'BartÄ±n': 'Karadeniz', 'KarabÃ¼k': 'Karadeniz', 'Zonguldak': 'Karadeniz', 'DÃ¼zce': 'Karadeniz', 'Bolu': 'Karadeniz',
  'Erzurum': 'DoÄŸu Anadolu', 'Erzincan': 'DoÄŸu Anadolu', 'Kars': 'DoÄŸu Anadolu', 'AÄŸrÄ±': 'DoÄŸu Anadolu',
  'IÄŸdÄ±r': 'DoÄŸu Anadolu', 'Ardahan': 'DoÄŸu Anadolu', 'MuÅŸ': 'DoÄŸu Anadolu', 'BingÃ¶l': 'DoÄŸu Anadolu',
  'Tunceli': 'DoÄŸu Anadolu', 'ElazÄ±ÄŸ': 'DoÄŸu Anadolu', 'Malatya': 'DoÄŸu Anadolu', 'Van': 'DoÄŸu Anadolu', 'Bitlis': 'DoÄŸu Anadolu', 'Hakkari': 'DoÄŸu Anadolu',
  'Gaziantep': 'GÃ¼neydoÄŸu Anadolu', 'ÅanlÄ±urfa': 'GÃ¼neydoÄŸu Anadolu', 'DiyarbakÄ±r': 'GÃ¼neydoÄŸu Anadolu',
  'Mardin': 'GÃ¼neydoÄŸu Anadolu', 'Batman': 'GÃ¼neydoÄŸu Anadolu', 'ÅÄ±rnak': 'GÃ¼neydoÄŸu Anadolu',
  'Siirt': 'GÃ¼neydoÄŸu Anadolu', 'Kilis': 'GÃ¼neydoÄŸu Anadolu', 'AdÄ±yaman': 'GÃ¼neydoÄŸu Anadolu'
};

/**
 * WIKIDATA Ä°L TAHMÄ°NÄ° (il="TÃ¼rkiye" olanlar iÃ§in)
 */
const WIKIDATA_IL_FIX = {
  'Q989883': 'Ä°stanbul',  // BÃ¼yÃ¼kada (Prens AdalarÄ±)
  'Q211817': 'Ã‡anakkale', // Bozcaada
  'Q658437': 'Ã‡anakkale', // GÃ¶kÃ§eada
};

/**
 * POST-PROCESSING: YasaklÄ± ifadeleri agresif temizleme
 */
function cleanText(text, areaName = '') {
  if (!text) return text;

  const isGokceada = areaName.toLowerCase().includes('gÃ¶kÃ§eada') || areaName.toLowerCase().includes('gokceada');

  const replacements = [
    // SÄ±ralama patterns - EXPANDED (en olmadan da)
    { pattern: /TÃ¼rkiye'nin en bÃ¼yÃ¼k (ikinci|Ã¼Ã§Ã¼ncÃ¼|dÃ¶rdÃ¼ncÃ¼|beÅŸinci|2\.|3\.|4\.) ada[sÄ±]?[Ä±dÄ±r]*/gi, replace: 'TÃ¼rkiye\'nin Ã¶nemli adalarÄ±ndan biri' },
    { pattern: /TÃ¼rkiye'nin (ikinci|Ã¼Ã§Ã¼ncÃ¼|dÃ¶rdÃ¼ncÃ¼|beÅŸinci|2\.|3\.|4\.) bÃ¼yÃ¼k ada[sÄ±]?[Ä±dÄ±r]*/gi, replace: 'TÃ¼rkiye\'nin Ã¶nemli adalarÄ±ndan biri' },
    { pattern: /Ä°stanbul'un en bÃ¼yÃ¼k (ikinci|Ã¼Ã§Ã¼ncÃ¼|dÃ¶rdÃ¼ncÃ¼|2\.|3\.|4\.) ada[sÄ±]?[Ä±dÄ±r]*/gi, replace: 'Ä°stanbul\'un Ã¶nemli adalarÄ±ndan biri' },
    { pattern: /Prens AdalarÄ±'nÄ±n en bÃ¼yÃ¼k (ikinci|Ã¼Ã§Ã¼ncÃ¼|dÃ¶rdÃ¼ncÃ¼|2\.|3\.|4\.) ada[sÄ±]?[Ä±dÄ±r]*/gi, replace: 'Prens AdalarÄ±\'nÄ±n bÃ¼yÃ¼k adalarÄ±ndan biri' },

    // "en bÃ¼yÃ¼k ada" (GÃ¶kÃ§eada hariÃ§)
    {
      pattern: /(?:TÃ¼rkiye'nin|Ä°stanbul'un|Prens AdalarÄ±'nÄ±n|grubun|takÄ±mÄ±nÄ±n) en bÃ¼yÃ¼k ada[sÄ±]?[Ä±dÄ±r]*/gi,
      replace: (match) => {
        if (isGokceada && match.includes("TÃ¼rkiye'nin")) {
          return match;
        }
        return match.replace(/en bÃ¼yÃ¼k ada[sÄ±]?[Ä±dÄ±r]*/, 'bÃ¼yÃ¼k adalarÄ±ndan biri');
      }
    },

    // DiÄŸer superlatifler - EXPANDED (dÃ¼r/olarak varyasyonlarÄ±)
    { pattern: /Prens AdalarÄ±'nÄ±n en bÃ¼yÃ¼ÄŸÃ¼[dÃ¼r]*\s*(olarak\s+bilinen)?/gi, replace: 'Prens AdalarÄ±\'nÄ±n bÃ¼yÃ¼k adalarÄ±ndan biri' },
    { pattern: /Prens AdalarÄ±'nÄ±n en bÃ¼yÃ¼ÄŸÃ¼dÃ¼r/gi, replace: 'Prens AdalarÄ±\'nÄ±n bÃ¼yÃ¼k adalarÄ±ndan biridir' },
    { pattern: /Ä°stanbul'un en bÃ¼yÃ¼k ada[sÄ±]?[Ä±dÄ±r]*/gi, replace: 'Ä°stanbul\'un bÃ¼yÃ¼k adalarÄ±ndan biri' },
    { pattern: /en bÃ¼yÃ¼k ada[sÄ±]?[Ä±dÄ±r]*/gi, replace: 'bÃ¼yÃ¼k adalardan biri' },
    { pattern: /en eski ada[sÄ±]?[Ä±dÄ±r]*/gi, replace: 'tarihi adalardan biri' },
    { pattern: /en yÃ¼ksek ada[sÄ±]?[Ä±dÄ±r]*/gi, replace: 'yÃ¼ksek adalardan biri' },
    { pattern: /en kÃ¼Ã§Ã¼k ada[sÄ±]?[Ä±dÄ±r]*/gi, replace: 'kÃ¼Ã§Ã¼k adalardan biri' },

    // BÃ¼yÃ¼kada Ã¶zel - bisiklet YASAK! (sadece fayton ve yaya)
    { pattern: /bisiklet ve at arabalar[Ä±Ä±]/gi, replace: 'at arabalar$1 (fayton)' },
    { pattern: /bisiklet[,]?\s*(ve|veya|ile)?\s*fayton/gi, replace: 'fayton (at arabasÄ±)' },
    { pattern: /bisiklet\s+(kiralama|veya|ve|ile|kiralanabilir)/gi, replace: (match, group) => {
      if (areaName.toLowerCase().includes('bÃ¼yÃ¼kada') || areaName.toLowerCase().includes('buyukada')) {
        return group === 'kiralama' ? 'fayton' : 'yaya veya fayton ile';
      }
      return match;
    }},
    { pattern: /bisikletle\s+gezm[ea]k/gi, replace: (match) => {
      if (areaName.toLowerCase().includes('bÃ¼yÃ¼kada') || areaName.toLowerCase().includes('buyukada')) {
        return 'faytonla gezmek';
      }
      return match;
    }},
    // BÃ¼yÃ¼kada: "bisiklet veya yaya" â†’ "yaya veya fayton ile"
    { pattern: /bisiklet\s+veya\s+yaya/gi, replace: (match) => {
      if (areaName.toLowerCase().includes('bÃ¼yÃ¼kada') || areaName.toLowerCase().includes('buyukada')) {
        return 'yaya veya fayton ile';
      }
      return match;
    }},
    // BÃ¼yÃ¼kada: "ziyaretÃ§iler... bisiklet" â†’ "fayton"
    { pattern: /ziyaretÃ§iler[^.]*bisiklet/gi, replace: (match) => {
      if (areaName.toLowerCase().includes('bÃ¼yÃ¼kada') || areaName.toLowerCase().includes('buyukada')) {
        return match.replace(/bisiklet/gi, 'fayton');
      }
      return match;
    }},
    // BÃ¼yÃ¼kada: "Bisiklet turu" â†’ "Fayton turu"
    { pattern: /bisiklet\s+turu?/gi, replace: (match) => {
      if (areaName.toLowerCase().includes('bÃ¼yÃ¼kada') || areaName.toLowerCase().includes('buyukada')) {
        return 'Fayton turu';
      }
      return match;
    }},
    // BÃ¼yÃ¼kada: "bisiklet kullanmak" â†’ "yaya gezmek"
    { pattern: /bisiklet\s+kullanmak/gi, replace: (match) => {
      if (areaName.toLowerCase().includes('bÃ¼yÃ¼kada') || areaName.toLowerCase().includes('buyukada')) {
        return 'yaya gezmek';
      }
      return match;
    }},

    // Gramer dÃ¼zeltmeleri
    { pattern: /birilarÄ±ndan birisidir/gi, replace: 'birisidir' },
    { pattern: /birilarÄ±ndan biri/gi, replace: 'biri' },
  ];

  let cleaned = text;
  for (const { pattern, replace } of replacements) {
    if (typeof replace === 'function') {
      cleaned = cleaned.replace(pattern, replace);
    } else {
      cleaned = cleaned.replace(pattern, replace);
    }
  }

  return cleaned;
}

/**
 * SYSTEM MESSAGE
 */
const SYSTEM_CONTEXT = `Sen TÃ¼rkiye'nin doÄŸal alanlarÄ± hakkÄ±nda profesyonel, detaylÄ± ve ansiklopedik iÃ§erik yazan bir uzmansÄ±n.

TEMEL PRENSÄ°PLER:
1. Objektif ve profesyonel ton kullan
2. Spesifik detaylar ver (genel laflar deÄŸil)
3. SÄ±ralama/karÅŸÄ±laÅŸtÄ±rma yapma
4. Emin olmadÄ±ÄŸÄ±nda dÃ¼rÃ¼st ol
5. Okuyucuya deÄŸerli bilgi sun`;

/**
 * Wikidata'dan zenginleÅŸtirilmiÅŸ bilgi Ã§ek
 */
async function fetchWikidataInfo(wikidataId) {
  if (!wikidataId) return null;

  try {
    const url = `https://www.wikidata.org/wiki/Special:EntityData/${wikidataId}.json`;
    const response = await axios.get(url, { timeout: 5000 });
    const entity = response.data.entities[wikidataId];

    if (!entity) return null;

    // YararlÄ± bilgileri Ã§Ä±kar
    const claims = entity.claims || {};

    return {
      label_tr: entity.labels?.tr?.value,
      description_tr: entity.descriptions?.tr?.value,
      // Koordinatlar
      coords: claims.P625?.[0]?.mainsnak?.datavalue?.value,
      // Alan (P2046)
      area: claims.P2046?.[0]?.mainsnak?.datavalue?.value,
      // YÃ¼kseklik (P2044)
      elevation: claims.P2044?.[0]?.mainsnak?.datavalue?.value,
      // Ä°l (P131 - located in)
      located_in: claims.P131?.[0]?.mainsnak?.datavalue?.value?.id,
    };
  } catch (error) {
    console.log(`  âš ï¸ Wikidata fetch failed for ${wikidataId}: ${error.message}`);
    return null;
  }
}

/**
 * 1. METADATA - Premium
 */
async function generateMetadata(area, wikidataInfo) {
  const alanTuru = area.alan_turu || area.tip || area.tur || 'doÄŸal alan';

  const prompt = `"${area.ad}" iÃ§in SEO-optimized metadata oluÅŸtur.

Bilgiler:
- TÃ¼r: ${alanTuru}
- Konum: ${area.il || 'TÃ¼rkiye'}${area.ilce ? ', ' + area.ilce : ''}
${wikidataInfo?.description_tr ? `- TanÄ±m: ${wikidataInfo.description_tr}` : ''}

GÃ¶rev:
1. Title: 50-60 karakter, SEO-friendly
2. Description: 140-155 karakter, etkileyici ve bilgilendirici
3. Keywords: 8-10 adet, alakalÄ± ve popÃ¼ler

JSON dÃ¶ndÃ¼r:
{
  "title": "...",
  "description": "...",
  "keywords": ["..."]
}`;

  const completion = await groq.chat.completions.create({
    messages: [
      { role: 'system', content: SYSTEM_CONTEXT },
      { role: 'user', content: prompt }
    ],
    model: 'llama-3.3-70b-versatile',
    temperature: 0.3,
    max_tokens: 400,
    response_format: { type: 'json_object' }
  });

  const result = JSON.parse(completion.choices[0].message.content);

  // Metadata'yÄ± da temizle (title, description, keywords)
  if (result.title) result.title = cleanText(result.title, area.ad);
  if (result.description) result.description = cleanText(result.description, area.ad);
  if (result.keywords && Array.isArray(result.keywords)) {
    result.keywords = result.keywords.map(k => cleanText(k, area.ad));
  }

  return result;
}

/**
 * 2. GENEL BAKIÅ - Zengin giriÅŸ
 */
async function generateGenelBakis(area, wikidataInfo) {
  const alanTuru = area.alan_turu || area.tip || area.tur || 'doÄŸal alan';

  const prompt = `"${area.ad}" hakkÄ±nda zengin bir giriÅŸ paragrafÄ± yaz (3-4 cÃ¼mle, 100-150 kelime).

Bilgiler:
- TÃ¼r: ${alanTuru}
- Konum: ${area.il}${area.ilce ? ', ' + area.ilce : ''}
${wikidataInfo?.description_tr ? `- AÃ§Ä±klama: ${wikidataInfo.description_tr}` : ''}
${wikidataInfo?.area ? `- Alan: ${wikidataInfo.area.amount} ${wikidataInfo.area.unit}` : ''}

Ä°Ã§erik:
- Ne olduÄŸu ve nerede olduÄŸu
- AyÄ±rt edici Ã¶zellikleri
- Neden Ã¶nemli/ilginÃ§

YASAK: SÄ±ralama (en bÃ¼yÃ¼k X'inci), ulaÅŸÄ±m detaylarÄ±

Sadece paragrafÄ± dÃ¶ndÃ¼r, baÅŸlÄ±k yok.`;

  const completion = await groq.chat.completions.create({
    messages: [
      { role: 'system', content: SYSTEM_CONTEXT },
      { role: 'user', content: prompt }
    ],
    model: 'llama-3.3-70b-versatile',
    temperature: 0.2,
    max_tokens: 300
  });

  return cleanText(completion.choices[0].message.content.trim(), area.ad);
}

/**
 * 3. TARÄ°HÃ‡E - Profesyonel ve detaylÄ±
 */
async function generateTarihce(area) {
  const prompt = `"${area.ad}" (${area.il}) tarihÃ§esi hakkÄ±nda profesyonel bir metin yaz.

Kurallar:
- SADECE "${area.ad}" hakkÄ±nda yaz
- Kronolojik sÄ±ra (antik dÃ¶nem â†’ gÃ¼nÃ¼mÃ¼z)
- Spesifik olaylar/dÃ¶nemler (varsa)
- Emin olmadÄ±ÄŸÄ±n tarih/kiÅŸi yazma
- 200-300 kelime

YASAK: BaÅŸka yerle karÄ±ÅŸtÄ±rma, sÄ±ralama

Metin dÃ¶ndÃ¼r.`;

  const completion = await groq.chat.completions.create({
    messages: [
      { role: 'system', content: SYSTEM_CONTEXT },
      { role: 'user', content: prompt }
    ],
    model: 'llama-3.3-70b-versatile',
    temperature: 0.1,
    max_tokens: 800
  });

  return cleanText(completion.choices[0].message.content.trim(), area.ad);
}

/**
 * 4. COÄRAFYA - DetaylÄ± ve spesifik
 */
async function generateCografya(area, wikidataInfo) {
  const coords = wikidataInfo?.coords || area.koordinatlar || area.coordinates || {};
  const areaSize = wikidataInfo?.area;
  const elevation = wikidataInfo?.elevation;

  const prompt = `"${area.ad}" coÄŸrafyasÄ± hakkÄ±nda detaylÄ± metin yaz.

Bilgiler:
- Konum: ${area.il}${area.ilce ? ', ' + area.ilce : ''}
${coords.latitude ? `- Koordinat: ${coords.latitude}Â°K, ${coords.longitude}Â°D` : ''}
${areaSize ? `- Alan: ${areaSize.amount} kmÂ²` : ''}
${elevation ? `- YÃ¼kseklik: ${elevation.amount} m` : ''}

Ä°Ã§erik (200-250 kelime):
- Kesin konum ve yakÄ±n yerler
- Fiziksel Ã¶zellikler (alan, yÃ¼kseklik, jeoloji)
- Ä°klim Ã¶zellikleri
- Ã–nemli coÄŸrafi noktalar

Metin dÃ¶ndÃ¼r.`;

  const completion = await groq.chat.completions.create({
    messages: [
      { role: 'system', content: SYSTEM_CONTEXT },
      { role: 'user', content: prompt }
    ],
    model: 'llama-3.3-70b-versatile',
    temperature: 0.1,
    max_tokens: 700
  });

  return cleanText(completion.choices[0].message.content.trim(), area.ad);
}

/**
 * 5. FLORA/FAUNA - Bilimsel ve spesifik
 */
async function generateFloraFauna(area) {
  const isIsland = (area.alan_turu || area.tip || area.tur || '').toLowerCase().includes('ada');

  const prompt = `"${area.ad}" flora ve fauna hakkÄ±nda bilimsel metin yaz.

${isIsland ? 'NOT: Bu bir ada - bÃ¼yÃ¼k memeliler yok. KuÅŸlar, kÃ¼Ã§Ã¼k hayvanlar, deniz canlÄ±larÄ±.' : ''}

Ä°Ã§erik (200-250 kelime):
- Bitki Ã¶rtÃ¼sÃ¼ (genel tanÄ±m + Ã¶rnekler)
- Hayvan tÃ¼rleri (kuÅŸlar, memeliler vb.)
- Endemik tÃ¼rler (varsa)
- Koruma durumu

Emin deÄŸilsen: "DetaylÄ± bilgi bulunmamaktadÄ±r" de.

Metin dÃ¶ndÃ¼r.`;

  const completion = await groq.chat.completions.create({
    messages: [
      { role: 'system', content: SYSTEM_CONTEXT },
      { role: 'user', content: prompt }
    ],
    model: 'llama-3.3-70b-versatile',
    temperature: 0.1,
    max_tokens: 700
  });

  return cleanText(completion.choices[0].message.content.trim(), area.ad);
}

/**
 * 6. ZÄ°YARET BÄ°LGÄ°LERÄ° - Pratik ve dÃ¼rÃ¼st
 */
async function generateZiyaret(area) {
  const alanTuru = (area.alan_turu || area.tip || area.tur || '').toLowerCase();
  const isIsland = alanTuru.includes('ada');

  const prompt = `"${area.ad}" iÃ§in KAPSAMLI ziyaret rehberi yaz.

Ä°Ã§erik (200-300 kelime, minimum 3 paragraf):
1. UlaÅŸÄ±m: ${isIsland ? 'Feribot/vapur bilgileri (varsa), kara yolu baÄŸlantÄ±larÄ±' : 'NasÄ±l gidilir? En yakÄ±n ÅŸehir, yol durumu'}
2. Ne yapÄ±lÄ±r?: Aktiviteler, gÃ¶rÃ¼lecek yerler, deneyimler
3. Ã–neriler: En iyi mevsim, geceleme, Ã¶neriler

${isIsland ? 'Ã–ZEL NOT: AdanÄ±n ulaÅŸÄ±mÄ±nda bisiklet/araÃ§ yasaÄŸÄ± varsa belirt!' : ''}

KURALLAR:
- Emin olmadÄ±ÄŸÄ±n detaylarÄ± yazma (fiyat, tam saat vb.)
- DÃ¼rÃ¼st ol: "GÃ¼ncel bilgi iÃ§in yerel kaynaklara danÄ±ÅŸÄ±nÄ±z"
- Pratik ve faydalÄ± ipuÃ§larÄ± ver
- MÄ°NÄ°MUM 200 KELÄ°ME YAZ!

JSON:
{
  "metin": "DetaylÄ± ziyaret bilgileri (200-300 kelime, 3+ paragraf)",
  "en_iyi_donem": "Ä°lkbahar ve sonbahar",
  "zorluk": "Kolay/Orta/Zor",
  "tahmini_sure": "2-3 saat",
  "aktiviteler": ["aktivite1", "aktivite2", "aktivite3"]
}`;

  const completion = await groq.chat.completions.create({
    messages: [
      { role: 'system', content: SYSTEM_CONTEXT },
      { role: 'user', content: prompt }
    ],
    model: 'llama-3.3-70b-versatile',
    temperature: 0.2,
    max_tokens: 1000,
    response_format: { type: 'json_object' }
  });

  const result = JSON.parse(completion.choices[0].message.content);
  result.metin = cleanText(result.metin, area.ad);

  // Aktiviteleri de temizle (Ã¶zellikle BÃ¼yÃ¼kada bisiklet iÃ§in)
  if (result.aktiviteler && Array.isArray(result.aktiviteler)) {
    result.aktiviteler = result.aktiviteler.map(a => cleanText(a, area.ad));
  }

  return result;
}

/**
 * 7. Ä°LGÄ°NÃ‡ BÄ°LGÄ°LER - Spesifik ve ilginÃ§
 */
async function generateIlgincBilgiler(area) {
  const prompt = `"${area.ad}" hakkÄ±nda 4-6 ilginÃ§, spesifik bilgi.

Kurallar:
- Spesifik olgular (genel laflar deÄŸil)
- DoÄŸrulanabilir bilgiler
- Ä°lginÃ§ detaylar

YASAK:
- SÄ±ralama (en bÃ¼yÃ¼k X'inci)
- UlaÅŸÄ±m uydurma
- Kesin olmayan tarih/kiÅŸi

JSON:
{
  "bilgiler": ["Bilgi 1", "Bilgi 2", ...]
}`;

  const completion = await groq.chat.completions.create({
    messages: [
      { role: 'system', content: SYSTEM_CONTEXT },
      { role: 'user', content: prompt }
    ],
    model: 'llama-3.3-70b-versatile',
    temperature: 0.2,
    max_tokens: 500,
    response_format: { type: 'json_object' }
  });

  const result = JSON.parse(completion.choices[0].message.content);
  if (result.bilgiler) {
    result.bilgiler = result.bilgiler.map(b => cleanText(b, area.ad));
  }
  return result;
}

/**
 * FULL CONTENT GENERATION
 */
async function generateFullContent(area, images) {
  console.log(`\nğŸ“ Ä°ÅŸleniyor: ${area.ad} (${area.il || 'Unknown'})`);

  try {
    // Wikidata bilgilerini Ã§ek
    console.log(`  ğŸ“¡ Wikidata bilgileri Ã§ekiliyor...`);
    const wikidataInfo = await fetchWikidataInfo(area.wikidata_id || area.wikidata_qid);

    // Ä°l dÃ¼zeltmesi (TÃ¼rkiye olanlar iÃ§in)
    let il = area.il;
    if (il === 'TÃ¼rkiye' && WIKIDATA_IL_FIX[area.wikidata_id]) {
      il = WIKIDATA_IL_FIX[area.wikidata_id];
      console.log(`  ğŸ”§ Ä°l dÃ¼zeltildi: TÃ¼rkiye â†’ ${il}`);
    }

    console.log(`  ğŸ”„ 7 bÃ¶lÃ¼m iÃ§in API call yapÄ±lacak...`);

    // 1. Metadata
    console.log(`  1/7 Metadata...`);
    const metadata = await generateMetadata({ ...area, il }, wikidataInfo);

    // 2. Genel BakÄ±ÅŸ
    console.log(`  2/7 Genel BakÄ±ÅŸ...`);
    const genelBakis = await generateGenelBakis({ ...area, il }, wikidataInfo);

    // 3. TarihÃ§e
    console.log(`  3/7 TarihÃ§e...`);
    const tarihce = await generateTarihce({ ...area, il });

    // 4. CoÄŸrafya
    console.log(`  4/7 CoÄŸrafya...`);
    const cografya = await generateCografya({ ...area, il }, wikidataInfo);

    // 5. Flora/Fauna
    console.log(`  5/7 Flora & Fauna...`);
    const floraFauna = await generateFloraFauna(area);

    // 6. Ziyaret
    console.log(`  6/7 Ziyaret...`);
    const ziyaret = await generateZiyaret(area);

    // 7. Ä°lginÃ§ Bilgiler
    console.log(`  7/7 Ä°lginÃ§ Bilgiler...`);
    const ilgincBilgiler = await generateIlgincBilgiler(area);

    // Frontmatter oluÅŸtur
    const coords = wikidataInfo?.coords || area.koordinatlar || area.coordinates || {};
    const alanTuru = area.alan_turu || area.tip || area.tur || 'doÄŸal_alan';
    const bolge = IL_BOLGE_MAP[il] || 'TÃ¼rkiye';

    // KaynaklarÄ± hazÄ±rla
    const kaynaklar = area.kaynaklar || [
      {
        title: 'tr.wikipedia.org',
        url: `https://tr.wikipedia.org/wiki/${encodeURIComponent(area.ad)}`,
        tip: 'genel'
      },
      {
        title: 'www.wikidata.org',
        url: `http://www.wikidata.org/entity/${area.wikidata_id || area.wikidata_qid}`,
        tip: 'genel'
      }
    ];

    const frontmatter = {
      title: metadata.title,
      date: new Date().toISOString(),
      draft: false,
      type: 'alan',
      alan_turu: alanTuru.toLowerCase().replace(/\s+/g, '_'),
      il: il || 'TÃ¼rkiye',
      ilce: area.ilce || '',
      bolge: bolge,
      coordinates: (coords.latitude || coords.lat) ? {
        lat: coords.latitude || coords.lat,
        lon: coords.longitude || coords.lon
      } : undefined,
      ziyaret: {
        en_iyi_donem: ziyaret.en_iyi_donem,
        zorluk: ziyaret.zorluk,
        tahmini_sure: ziyaret.tahmini_sure
      },
      aktiviteler: ziyaret.aktiviteler || [],
      images: formatImages(images, area),
      kaynaklar: kaynaklar,
      description: metadata.description,
      keywords: metadata.keywords,
      schema_type: 'TouristAttraction',
      wikidata_id: area.wikidata_id || area.wikidata_qid || ''
    };

    // Markdown iÃ§erik
    const content = `---
${Object.entries(frontmatter).filter(([_, v]) => v !== undefined && v !== '').map(([k, v]) => {
  if (typeof v === 'object' && !Array.isArray(v)) {
    return `${k}:\n${Object.entries(v).map(([k2, v2]) => `  ${k2}: ${JSON.stringify(v2)}`).join('\n')}`;
  }
  return `${k}: ${JSON.stringify(v)}`;
}).join('\n')}
---

# ${area.ad}

${genelBakis}

## TarihÃ§e

${tarihce}

## CoÄŸrafya

${cografya}

## Flora ve Fauna

${floraFauna}

## Ziyaret Bilgileri

${ziyaret.metin}

## Ä°lginÃ§ Bilgiler

${ilgincBilgiler.bilgiler.map(b => `- ${b}`).join('\n')}
`;

    // Dosya yaz
    const filename = (area.id || area.ad.toLowerCase())
      .replace(/Ä±/g, 'i').replace(/ÄŸ/g, 'g').replace(/Ã¼/g, 'u')
      .replace(/ÅŸ/g, 's').replace(/Ã¶/g, 'o').replace(/Ã§/g, 'c')
      .replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');

    const filepath = path.join(CONTENT_DIR, `${filename}.md`);
    fs.writeFileSync(filepath, content, 'utf-8');

    const imageInfo = images && images.length > 0 ? 'âœ… GÃ¶rselli' : 'ğŸ“· GÃ¶rselsiz';
    console.log(`  âœ… OluÅŸturuldu: ${filename}.md ${imageInfo}`);
    return true;

  } catch (error) {
    console.error(`  âŒ Hata: ${error.message}`);
    return false;
  }
}

function formatImages(images, area) {
  if (!images || images.length === 0) return {};

  const validImages = images.filter(img => img && img.url);
  if (validImages.length === 0) return {};

  return {
    hero: {
      url: validImages[0].url,
      alt: `${area.ad} manzarasÄ±`,
      credit: validImages[0].credit || 'Wikimedia Commons',
      license: validImages[0].license || 'CC BY-SA'
    },
    gallery: validImages.slice(1, 6).map(img => ({
      url: img.url,
      thumb: img.thumb || img.url,
      alt: `${area.ad}${img.title ? ' - ' + img.title : ''}`,
      credit: img.credit || 'Wikimedia Commons',
      license: img.license || 'CC BY-SA'
    }))
  };
}

async function fetchWikimediaImages(searchTerm, limit = 5) {
  try {
    const response = await axios.get('https://commons.wikimedia.org/w/api.php', {
      params: {
        action: 'query',
        format: 'json',
        generator: 'search',
        gsrsearch: `${searchTerm}`,
        gsrlimit: limit,
        prop: 'imageinfo',
        iiprop: 'url|extmetadata',
        iiurlwidth: 1200
      },
      timeout: 10000
    });

    if (!response.data.query) return [];

    return Object.values(response.data.query.pages)
      .filter(page => page.imageinfo && page.imageinfo[0])
      .map(page => ({
        url: page.imageinfo[0].url || '',
        thumb: page.imageinfo[0].thumburl || page.imageinfo[0].url || '',
        title: page.title?.replace('File:', '').replace(/\.[^/.]+$/, ''),
        credit: page.imageinfo[0].extmetadata?.Artist?.value || 'Wikimedia Commons',
        license: page.imageinfo[0].extmetadata?.License?.value || 'CC BY-SA'
      }));
  } catch (error) {
    console.log(`  âš ï¸ GÃ¶rsel Ã§ekme hatasÄ±: ${error.message}`);
    return [];
  }
}

/**
 * MAIN
 */
async function main() {
  console.log('\nğŸš€ PREMIUM Ä°Ã§erik Ãœretimi v5 - TÃœRKÄ°YE\'NÄ°N EN KALÄ°TELÄ° TABÄ°AT REHBERÄ°');
  console.log('============================================================');
  console.log('ğŸ“Š Wikidata entegrasyonu + Premium promptlar + Zero bugs');
  console.log('============================================================\n');

  if (!fs.existsSync(CONTENT_DIR)) {
    fs.mkdirSync(CONTENT_DIR, { recursive: true });
  }

  const mergedFiles = isTestMode
    ? ['test-merged.json']
    : fs.readdirSync(MASTER_LISTS_DIR).filter(f => f.endsWith('-merged.json'));

  let totalProcessed = 0;
  let totalSuccess = 0;

  for (const file of mergedFiles) {
    console.log(`\nğŸ“‹ Liste: ${file}`);
    const data = JSON.parse(fs.readFileSync(path.join(MASTER_LISTS_DIR, file), 'utf-8'));

    console.log(`   Toplam alan sayÄ±sÄ±: ${data.alanlar?.length || 0}`);

    for (const area of data.alanlar || []) {
      console.log(`  ğŸ“¸ GÃ¶rseller aranÄ±yor...`);
      const images = await fetchWikimediaImages(area.ad, 5);
      console.log(`  ğŸ“¸ ${images.length} gÃ¶rsel bulundu`);

      const success = await generateFullContent(area, images);

      if (success) totalSuccess++;
      totalProcessed++;

      await new Promise(resolve => setTimeout(resolve, 2000)); // Rate limit
    }
  }

  console.log('\n============================================================');
  console.log('âœ… Ä°Ã§erik Ã¼retimi tamamlandÄ±!');
  console.log(`ğŸ“Š Ä°statistikler:`);
  console.log(`   - Ä°ÅŸlenen alan: ${totalProcessed}`);
  console.log(`   - BaÅŸarÄ±lÄ±: ${totalSuccess}`);
  console.log(`   - BaÅŸarÄ±sÄ±z: ${totalProcessed - totalSuccess}`);
  console.log(`ğŸ“ Ã‡Ä±ktÄ±: ${CONTENT_DIR}`);
  console.log('============================================================\n');
}

main();
